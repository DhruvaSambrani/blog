<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang xml:lang><meta charset=utf-8><meta name=generator content="pandoc"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=author content="Dhruva Sambrani"><meta name=keywords content="self-hosting,hacking"><title>Tailscale on Kindle | Dhruva's Blog</title><link rel=stylesheet href=/blog/assets/css/pandoc-styles.css><link rel=stylesheet href=/blog/assets/css/styles.css><script data-external=1 src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js></script><div class=markdown-body><h1 id=tailscale-on-kindle>Tailscale on Kindle</h1><p>Tailscale just posted a <a href=https://tailscale.com/blog/tailscale-jailbroken-kindle>blogpost</a> on getting tailscale to work on kindle. I had tried this before, but I had to make some major changes before it worked on my old kindle. Since jailbreaks are most useful on old tech anyway, I thought it was prudent to write a post highlighting what went wrong and what I had to fix.<h1 id=jailbreaking-the-kindle>Jailbreaking the Kindle</h1><p>I have a Gen 8 Kindle Basic fromâ€¦ 2015?<p>I have tried to get self-hosted reading forever, and the biggest issue was getting epubs on kindle. Calibre is so good, its basically jellyfin for books, but it needs a cable to connect to any device. You could use the content server, but I donâ€™t think you can start it headless on a server. Also I donâ€™t think you can do progress syncing, but Iâ€™m probably wrong. Even if that wasnâ€™t an issue, the default kindle firmware doesnâ€™t allow you to read epub files, which are probably the most ubiquitous. There is no open source application that you can use on an Android phone either. I kind of left this for almost 5-6 years, but still kept bringing it with me on every move.<p>Regardless, with the <a href=https://kindlemodding.org/jailbreaking/WinterBreak/>WinterBreak</a> jailbreak released, it becomes a lot easier. After applying the jailbreak, I also installed the KUAL framework, and then the <a href=https://koreader.rocks/>KOReader</a> application. This also has an android application, and lots and lots of plugins. It also has a progress sync, but it syncs to a public server.<p>As I did this, I started thinking about my <a href=2025-04-22_155445>Currently selfhosted services</a>. It should be easy enough to self-host <a href=https://github.com/crocodilestick/Calibre-Web-Automated/>Calibre-Web-Advanced</a>, which also has a sync plugin (itâ€™s basically a slightly modified version of the ProgressSync plugin that comes default with KOReader). It also provides an OPDS endpoint so I can get files onto the kindle.<p>But all this depends on the kindle being able to connect to the server.<h1 id=connect-to-tailscale>Connect to Tailscale</h1><p>I already use Tailscale for <a href=2025-04-21_200237>Self Hosting without a public IP address or domain</a>, so I just had to get the kindle on the tailnet. I tried to use subnet-routing, but that only works for <em>incoming</em> connections, not outgoing.<p>Thatâ€™s when I came across <a href=https://github.com/mitanshu7/tailscale_kual>Tailscale for KUAL</a>. I tried to install and run it, and it worked! â€¦ Almost. See <a href=https://github.com/mitanshu7/tailscale_kual/issues/2>mitanshu7/tailscale_kual#2</a>. However, because my kindle kernel does not have the tun.ko kernel module compiled in, I could not use the fix in that issue. The socks5 proxy fix and some AI asking, it told me to instead use the http proxy setting. Note that this is a good time to start using the ssh plugin on the kindle to ssh in!<p>While the following changes also work for the KUAL plugin above, I realised that the <a href=https://github.com/victoria-riley-barnett/koreader-tailscale>koreader plugin for tailscale</a> would probably be easier to work with. It does basically the same thing.<p>So I changed the lines<div class=sourceCode id=cb1><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb1-1><a href=#cb1-1 aria-hidden=true tabindex=-1></a><span class=co># Start daemon</span></span>
<span id=cb1-2><a href=#cb1-2 aria-hidden=true tabindex=-1></a><span class=fu>nohup</span> ./tailscaled <span class=at>--statedir</span><span class=op>=</span>/mnt/us/tailscale/bin/ <span class=op>&gt;</span> tailscaled.log <span class=dv>2</span><span class=op>&gt;&amp;</span><span class=dv>1</span> <span class=kw>&amp;</span></span></code></pre></div><p>in <code>./bin/start_tailscale.sh</code> with<div class=sourceCode id=cb2><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb2-1><a href=#cb2-1 aria-hidden=true tabindex=-1></a><span class=co># Start daemon</span></span>
<span id=cb2-2><a href=#cb2-2 aria-hidden=true tabindex=-1></a><span class=fu>nohup</span> ./tailscaled <span class=at>--statedir</span><span class=op>=</span>/mnt/us/tailscale/bin/ <span class=at>--tun</span><span class=op>=</span>userspace-networking <span class=at>--outbound-http-proxy-listen</span><span class=op>=</span>localhost:8080 <span class=at>--socks5-server</span><span class=op>=</span>localhost:1055 <span class=op>&gt;</span> tailscaled.log <span class=dv>2</span><span class=op>&gt;&amp;</span><span class=dv>1</span> <span class=kw>&amp;</span></span></code></pre></div><p>Now setting the <code>HTTP proxy</code> variable in <code>Settings > Network > HTTP Proxy</code> to <code>http://localhost:8080</code> should have just worked. But when has life ever been so kind?<h1 id=lua-shenanigans-and-vibe-coding>Lua shenanigans and vibe coding</h1><p>The <code>CWASync</code> plugin was not able to connect to the server in spite of the http proxy. The proxy itself worked, I checked by <code>curl</code>ing from the <code>ash</code> shell plugin with the <code>http_proxy</code> envvar set. The OPDS plugin and<p>There were no logs to <code>crash.log</code> either. With a lot of help from AIStudio I added logging to check why the connection was failing to my tailscale server. It initially looked like <code>SPORE</code> was the issue, but the error log string was not found in the Spore library. So I just <code>grep</code>ed the string in the <code>common</code> folder in koreader. This way, I finally realised that this was because the <code>luasec</code> library <a href=https://github.com/lunarmodules/luasec/blob/989ee5f993c4d2486c25763c079b9f3163336dc9/src/https.lua#L124>does not support</a> https over a proxy. There was an <a href=https://github.com/lunarmodules/luasec/pull/102>attempt</a> to add this feature, but it seems the original author never finished it.<p>So I asked AIStudio to vibe code the fix. It did surprisingly well, except it seemed that the initial connection to the http proxy was also going through ssl, which was not necessary. The easy way was to simply bypass when a local connection was required. Ideally it should implement <code>noproxy</code> support, but ðŸ¤·.<p>I added this fix to <a href=https://github.com/DhruvaSambrani/luasec/tree/add-proxy-redirect-custom>my fork of luasec</a>.<p><strong>To use it in my KOReader build</strong>, I just had to replace <code>koreader/common/ssl/https.lua</code> with the new file. Now everything works!<h1 id=upstreaming>Upstreaming</h1><p>I donâ€™t exactly know how to upstream this change. Should it go to <code>luasec</code>? Or should KOReader replace <code>luasec</code> with <code>lua-http</code>? Let your opinion be known on <a href=https://github.com/koreader/koreader/issues/14693>this issue</a>.</div><div class="markdown-body tags"><a href=/blog/tags.html#self-hosting>#self-hosting<a>, <a href=/blog/tags.html#hacking>#hacking<a></div><footer><a class=footer-button id=home href=/blog/tags.html>Tags</a>
<img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by-nc/4.0/88x31.png>
<a id=fivetwelvea href=https://512kb.club><img id=fivetwelve alt="a proud member of the green team of 512KB club"></a>
<a class=footer-button id=contents href=/blog/contents.html>Contents</a></footer>